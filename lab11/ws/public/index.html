<!DOCTYPE html>
<html>

<head>
  <title>WebSocket API</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/styl.css" />
  <script src="js/jquery.min.js"></script>
  <script src="js/skrypt.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.0.1/mqtt.min.js" type="text/javascript"></script>
</head>

</head>

<body>
  <h1 id="title">WebSocket API</h1>
  <h3>Chats:</h3>
  <ul id="chats"></ul>
  <h3>Create your char:</h3>
  <input type="text" id="roomName">
  <button id="btn" onclick="createChat(document.getElementById('roomName').value, document.getElementById('chats'))">Create your chat</button>
  <h3>Write twit</h3>
  <div>chat:</div>
  <input type="text" id="chatName">
  <div>text:</div>
  <input type="text" id="twit">
  <button id="twitbutton" onclick="sendTwit(document.getElementById('twit').value, document.getElementById('chatName').value)">Send ></button>
  <h3>Twits</h3>
  <div id="twits"></div>
  <script>

    const clientId = 'mqttjs_' + Math.random().toString(16).substr(2, 8)
    const host = 'ws://broker.emqx.io:8083/mqtt'
    const options = {
      keepalive: 60,
      clientId: clientId,
      protocolId: 'MQTT',
      protocolVersion: 4,
      clean: true,
      reconnectPeriod: 1000,
      connectTimeout: 30 * 1000,
      will: {
        topic: 'WillMsg',
        payload: 'Connection Closed abnormally..!',
        qos: 0,
        retain: false
      },
    }
    console.log('Connecting mqtt client')
    const client = mqtt.connect(host, options)

    client.on('message', (topic, string) => {
      if(topic.toString()==='loaded'){
        console.log("loaded")
        //client.unsubscribe('loaded')
        const chats=string.toString().split('|')
        const rooms = document.getElementById('chats')
        //list of ids
        const lis = rooms.getElementsByTagName('li');
        const idArray = [];
        for ( let counter = 0; counter < lis.length; counter++){
          idArray.push( lis[counter].id );
        }
        //if
        if(chats[0] != ''){
          chats.forEach(chatname => {
            if(idArray.filter(id => id == chatname).length == 0){
            //if($('#ulId').find('#1').length = 0){
              let li = document.createElement("li");
              li.innerText = chatname;
              li.id = chatname
              rooms.appendChild(li);

              let joinbutton = document.createElement("button");
              joinbutton.innerHTML = "Join";
              joinbutton.onclick = function(){
                li.removeChild(joinbutton)
                let leavebutton = document.createElement("button");
                leavebutton.innerHTML = "Leave";
                leavebutton.onclick = function(){
                  li.removeChild(leavebutton)
                  li.appendChild(joinbutton);
                  client.publish('twits', `${chatname}|${clientId}|${username} left ${chatname}`)
                  client.publish("leaveChat", `${chatname}|${clientId}`)
                  client.unsubscribe(chatname)
                  //client.unsubscribe(chatname)
                }
                li.appendChild(leavebutton);
                client.publish("joinChat", `${chatname}|${clientId}`)
                client.publish('twits', `${chatname}|${clientId}|${username} joined ${chatname}`)
                client.subscribe(chatname)
              }
              li.appendChild(joinbutton);
            }
          })
        
        }
      }
      else {
        if(topic.toString()==='deleteChat'){
          let child = document.getElementById(string)
          rooms.removeChild(child)
        }else{
          console.log("checkedTwit")
          const chat_id_twit = string.toString().split('|')
          let twits = document.getElementById("twits")
          let div = document.createElement("div");
          div.innerText = `${chat_id_twit[1]}: ${chat_id_twit[2]}`;
          if(chat_id_twit[2] != undefined){
            twits.appendChild(div)
          }
          //}

        }
    }
      //let twits = document.getElementById("twits")
      /*client.on("twits", twit => {
        let div = document.createElement("div");
        div.innerText = twit;
        twits.appendChild(div)
      })*/

      /*client.on("deleteChat", chatname => {
        let child = document.getElementById(chatname)
        rooms.removeChild(child)
      })*/
    });
  </script>
</body>

</html>